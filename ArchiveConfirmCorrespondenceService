@Service
@Slf4j
public class CorrespondenceService {

    private final MailItConfirmCache mailItConfirmCache;
    private final MailitArchiveCache mailitArchiveCache;
    private final UserInfoServiceImpl userInfoService;
    private final SetItPullClientCache setItPullClientCache;
    private final DocArchiveCache docArchiveCache;
    private final RsDataServiceCache rsDataServiceCache;

    CorrespondenceService(final MailItConfirmCache mailItConfirmCache,
                          final RsDataServiceCache rsDataServiceCache,
                          final MailitArchiveCache mailitArchiveCache,
                          final DocArchiveCache docArchiveCache,
                          final SetItPullClientCache setItPullClientCache, final UserInfoServiceImpl userInfoService) {
        this.mailItConfirmCache = mailItConfirmCache;
        this.docArchiveCache = docArchiveCache;
        this.mailitArchiveCache = mailitArchiveCache;
        this.userInfoService = userInfoService;
        this.setItPullClientCache = setItPullClientCache;
        this.rsDataServiceCache = rsDataServiceCache;
    }

    public CorrespondenceResponse getCorrespondenceDocs(final Map<String, String> reqHeadersMap) {
        log.info(">>> correspondence doc");
        PartyInfo partyInfo = userInfoService.getParty(reqHeadersMap);
        Client client = setItPullClientCache.getClient(partyInfo.getClientId());
        log.info("client {}", client);

        CorrespondenceResponse correspondenceResponse = null;
        if (null != client) {
            String confirmSource = client.getConfirmSource();

            if (ConfirmSourceType.ECOR.name().equalsIgnoreCase(confirmSource)) {
                correspondenceResponse = mailItConfirmCache.getCorrespondenceDocs(reqHeadersMap, partyInfo);
                correspondenceResponse.setConfirmSourceType(ConfirmSourceType.ECOR);
            } else if (ConfirmSourceType.DOCARCHIVE.name().equalsIgnoreCase(confirmSource)) {
                correspondenceResponse = docArchiveCache.getCorrespondenceArchDocsList(reqHeadersMap, partyInfo);
                correspondenceResponse.setConfirmSourceType(ConfirmSourceType.DOCARCHIVE);
            } else if (ConfirmSourceType.DOCARCHIVEECOR.name().equalsIgnoreCase(confirmSource)) {
                correspondenceResponse = mailitArchiveCache.getCorrespondenceDocs(reqHeadersMap, partyInfo);
                correspondenceResponse.setConfirmSourceType(ConfirmSourceType.DOCARCHIVEECOR);
            }
        }
        if (null != correspondenceResponse) {
            Map<String, String> siteManagerValuesMap = rsDataServiceCache.getSiteManagerValues(partyInfo.getClientId(),
                    null, CrspConstants.MAILPREFERENCES);
            correspondenceResponse.setStatementBulletPoints(siteManagerValuesMap.get(CrspConstants.MSG_STATEMENT_BULLET_POINTS));
            correspondenceResponse.setCorrespondenceText(client.getTextCorrespondence());
        }
        log.info("<<< Exit correspondence doc response {}", correspondenceResponse);
        return Objects.requireNonNullElse(correspondenceResponse, CorrespondenceResponse.builder().build());
    }
}
