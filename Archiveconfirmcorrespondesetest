import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

import java.text.SimpleDateFormat;
import java.util.*;
import java.util.concurrent.*;

import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

@ExtendWith(MockitoExtension.class)
class CombineConfirmCorrespondenceServiceTest {

    @Mock
    private ArchiveDocsRestService archiveDocsRestService;

    @Mock
    private MailItPreferenceService mailItPreferenceService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private RequestService requestService;

    @Mock
    private ClientParticipantInfoCache clientParticipantInfoCache;

    @InjectMocks
    private CombineConfirmCorrespondenceService combineConfirmCorrespondenceService;

    private Executor executor;

    @BeforeEach
    void setUp() {
        // Simulate the @Autowired @Qualifier("asyncExecutor")
        ThreadPoolTaskExecutor taskExecutor = new ThreadPoolTaskExecutor();
        taskExecutor.setCorePoolSize(1);
        taskExecutor.initialize();
        combineConfirmCorrespondenceService.correspondenceExecutor = taskExecutor;
    }

    @Test
    void testGetCorrespondenceDocs_successfulFlow() throws Exception {
        Map<String, String> reqHeaders = Map.of("header1", "value1");
        PartyInfo partyInfo = new PartyInfo();
        partyInfo.setSsn("123456789");
        partyInfo.setClientId("client123");

        Account account = new Account();
        account.setPlanType("SAVINGS");
        account.setVoyaAccessPlan(false);
        account.setPlanId("planId1");
        account.setPlanName("Plan 1");

        when(requestService.getPreAuthHeadersMap(reqHeaders)).thenReturn(Map.of());
        when(requestService.getAccountsList(any(), any())).thenReturn(List.of(account));

        Client client = new Client();
        client.setClientId("client123");
        client.setConfirmSource(ConfirmSourceType.ECOR.name());
        when(setItPullClientCache.getClient("client123")).thenReturn(client);

        List<ArchiveDocsInfo> archiveDocsInfos = new ArrayList<>();
        ArchiveDocsInfo archiveDoc = new ArchiveDocsInfo();
        archiveDoc.setPlanNo("planId1");
        archiveDoc.setPlanName("Plan 1");
        archiveDoc.setSysDocName("sysDoc1");
        archiveDoc.setUserDocName("userDoc1");
        archiveDoc.setRunDate(new Date());
        archiveDoc.setTransactionDate(new Date());
        archiveDoc.setDocQueryParamName("param");
        archiveDoc.setDocQueryParamValue("value");
        archiveDoc.setDocViewURL("url");
        archiveDocsInfos.add(archiveDoc);

        when(archiveDocsRestService.getEaseCorrespondenceDocList(any(), any(), anyBoolean()))
                .thenReturn(archiveDocsInfos);

        MailFolder mailFolder = new MailFolder();
        MailInfo mailInfo = new MailInfo();
        mailInfo.setBeginDate(javax.xml.datatype.DatatypeFactory.newInstance()
                .newXMLGregorianCalendar(new GregorianCalendar()));
        DocumentInfo documentInfo = new DocumentInfo();
        documentInfo.setPlanId("planId1");
        documentInfo.setSysDocName("sysDocName");
        documentInfo.setUserDocName("userDocName");
        documentInfo.setMessageId("messageId");
        documentInfo.setDocumentId("docId");
        mailInfo.setDocumentInfo(List.of(documentInfo));
        mailFolder.setMailInfo(List.of(mailInfo));

        when(mailItPreferenceService.getCombinedMailFolder(any(), any(), any(), any(), any(), any()))
                .thenReturn(mailFolder);

        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType(any(), any(), any()))
                .thenReturn(List.of("planId1"));
        PlanGeneralInfo planGeneralInfo = new PlanGeneralInfo();
        planGeneralInfo.setUsePlanLevelCustomBranding("Y");
        when(setItPullClientCache.getSetItPlanGeneralInfo(any())).thenReturn(planGeneralInfo);

        CorrespondenceResponse response = combineConfirmCorrespondenceService.getCorrespondenceDocs(reqHeaders, partyInfo);

        assertNotNull(response);
        assertTrue(response.isUsePlanLvlBrand());
        assertNotNull(response.getComboCorresInfos());
        assertFalse(response.getComboCorresInfos().isEmpty());
    }

    @Test
    void testGetCorrespondenceDocs_emptyPlanList() {
        Map<String, String> reqHeaders = Map.of("header1", "value1");
        PartyInfo partyInfo = new PartyInfo();
        partyInfo.setSsn("123456789");
        partyInfo.setClientId("client123");

        when(requestService.getPreAuthHeadersMap(reqHeaders)).thenReturn(Map.of());
        when(requestService.getAccountsList(any(), any())).thenReturn(Collections.emptyList());

        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType(any(), any(), any()))
                .thenReturn(Collections.emptyList());

        CorrespondenceResponse response = combineConfirmCorrespondenceService.getCorrespondenceDocs(reqHeaders, partyInfo);

        assertNotNull(response);
        assertFalse(response.isUsePlanLvlBrand());
        assertTrue(response.getComboCorresInfos() == null || response.getComboCorresInfos().isEmpty());
    }

    @Test
    void testBuildMailItArchiveDocsList_ExceptionHandling() throws Exception {
        Map<String, String> reqHeaders = Map.of();
        PartyInfo partyInfo = new PartyInfo();
        partyInfo.setSsn("987654321");
        partyInfo.setClientId("clientIdTest");

        Account account = new Account();
        account.setPlanType("SAVINGS");
        account.setVoyaAccessPlan(false);
        account.setPlanId("plan123");
        account.setPlanName("Test Plan");

        when(requestService.getPreAuthHeadersMap(reqHeaders)).thenReturn(Map.of());
        when(requestService.getAccountsList(any(), any())).thenReturn(List.of(account));

        Client client = new Client();
        client.setClientId("clientIdTest");
        client.setConfirmSource("CEDARARCHIVEECOR");
        when(setItPullClientCache.getClient("clientIdTest")).thenReturn(client);

        when(archiveDocsRestService.getEaseCorrespondenceDocList(any(), any(), anyBoolean()))
                .thenThrow(new RuntimeException("Simulated Exception"));

        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType(any(), any(), any()))
                .thenReturn(Collections.emptyList());

        // Even if archiveDocsRestService fails, exception handling should be tested
        assertThrows(RestClientApiException.class, () -> {
            combineConfirmCorrespondenceService.getCorrespondenceDocs(reqHeaders, partyInfo);
        });
    }
}
