

import com.voya.ptpcrsp.correspondence.cache.*;
import com.voya.ptpcrsp.correspondence.model.CorrespondenceResponse;
import com.voya.ptpcrsp.correspondence.model.PartyInfo;
import com.voya.ptpcrsp.correspondence.model.ConfirmSourceType;
import com.voya.ptpcrsp.correspondence.model.CrspConstants;
import com.voya.setitpullclient.model.Client;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class CorrespondenceServiceTest {

    @InjectMocks
    private CorrespondenceService correspondenceService;

    @Mock
    private MailItConfirmCache mailItConfirmCache;

    @Mock
    private MailitArchiveCache mailitArchiveCache;

    @Mock
    private UserInfoServiceImpl userInfoService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private DocArchiveCache docArchiveCache;

    @Mock
    private RsDataServiceCache rsDataServiceCache;

    private Map<String, String> headers;

    private PartyInfo partyInfo;
    private Client client;
    private CorrespondenceResponse response;

    @BeforeEach
    void setUp() {
        headers = new HashMap<>();
        partyInfo = new PartyInfo();
        partyInfo.setClientId("12345");

        client = new Client();
        response = CorrespondenceResponse.builder().build();
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSource_ECOR() {
        client.setConfirmSource(ConfirmSourceType.ECOR.name());
        client.setTextCorrespondence("Test Text");

        when(userInfoService.getParty(any())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(mailItConfirmCache.getCorrespondenceDocs(any(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any()))
                .thenReturn(Collections.singletonMap(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.ECOR, result.getConfirmSourceType());
        assertEquals("Bullet Points", result.getStatementBulletPoints());
        assertEquals("Test Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSource_DOCARCHIVE() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVE.name());
        client.setTextCorrespondence("Doc Archive Text");

        when(userInfoService.getParty(any())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(docArchiveCache.getCorrespondenceArchDocsList(any(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any()))
                .thenReturn(Collections.singletonMap(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.DOCARCHIVE, result.getConfirmSourceType());
        assertEquals("Bullet Points", result.getStatementBulletPoints());
        assertEquals("Doc Archive Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSource_DOCARCHIVEECOR() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVEECOR.name());
        client.setTextCorrespondence("DocArchiveECOR Text");

        when(userInfoService.getParty(any())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(mailitArchiveCache.getCorrespondenceDocs(any(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any()))
                .thenReturn(Collections.singletonMap(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.DOCARCHIVEECOR, result.getConfirmSourceType());
        assertEquals("Bullet Points", result.getStatementBulletPoints());
        assertEquals("DocArchiveECOR Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_whenClientIsNull() {
        when(userInfoService.getParty(any())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(null);

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertNull(result.getConfirmSourceType());
        assertNull(result.getStatementBulletPoints());
        assertNull(result.getCorrespondenceText());
    }
}
