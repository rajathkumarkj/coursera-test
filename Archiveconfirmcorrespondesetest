import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

@ExtendWith(MockitoExtension.class)
class CorrespondenceServiceTest {

    @Mock
    private MailItConfirmCache mailItConfirmCache;

    @Mock
    private MailitArchiveCache mailitArchiveCache;

    @Mock
    private UserInfoServiceImpl userInfoService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private DocArchiveCache docArchiveCache;

    @Mock
    private RsDataServiceCache rsDataServiceCache;

    @InjectMocks
    private CorrespondenceService correspondenceService;

    private Map<String, String> reqHeadersMap;
    private PartyInfo partyInfo;
    private Client client;

    @BeforeEach
    void setUp() {
        reqHeadersMap = new HashMap<>();
        partyInfo = new PartyInfo();
        partyInfo.setClientId("clientId");

        client = new Client();
    }

    @Test
    void testGetCorrespondenceDocs_ECOR() {
        client.setConfirmSource(ConfirmSourceType.ECOR.name());
        client.setTextCorrespondence("Test Text");

        CorrespondenceResponse response = CorrespondenceResponse.builder().build();

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);
        when(mailItConfirmCache.getCorrespondenceDocs(reqHeadersMap, partyInfo)).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.ECOR, result.getConfirmSourceType());
        assertEquals("Bullet Points", result.getStatementBulletPoints());
        assertEquals("Test Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_DOCARCHIVE() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVE.name());
        client.setTextCorrespondence("DocArchive Text");

        CorrespondenceResponse response = CorrespondenceResponse.builder().build();

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);
        when(docArchiveCache.getCorrespondenceArchDocsList(reqHeadersMap, partyInfo)).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "DocArchive Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.DOCARCHIVE, result.getConfirmSourceType());
        assertEquals("DocArchive Bullet Points", result.getStatementBulletPoints());
        assertEquals("DocArchive Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_DOCARCHIVEECOR() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVEECOR.name());
        client.setTextCorrespondence("DocArchiveECOR Text");

        CorrespondenceResponse response = CorrespondenceResponse.builder().build();

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);
        when(mailitArchiveCache.getCorrespondenceDocs(reqHeadersMap, partyInfo)).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "DocArchiveECOR Bullet Points"));

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(result);
        assertEquals(ConfirmSourceType.DOCARCHIVEECOR, result.getConfirmSourceType());
        assertEquals("DocArchiveECOR Bullet Points", result.getStatementBulletPoints());
        assertEquals("DocArchiveECOR Text", result.getCorrespondenceText());
    }

    @Test
    void testGetCorrespondenceDocs_NoClient() {
        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(null);

        CorrespondenceResponse result = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(result);
        assertNull(result.getConfirmSourceType());
        assertNull(result.getStatementBulletPoints());
        assertNull(result.getCorrespondenceText());
    }
}
