import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.ws.client.core.WebServiceTemplate;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import javax.xml.bind.JAXBElement;

import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.*;

class MailPreferencesDAOTest {

    @Mock
    private WebServiceTemplate webServiceTemplate;

    @Mock
    private HttpServletResponse response;

    @InjectMocks
    private MailPreferencesDAO mailPreferencesDAO;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        mailPreferencesDAO = new MailPreferencesDAO(webServiceTemplate, "http://mock.mailservice.url", response);
    }

    @Test
    void testGetDocument_validData() throws Exception {
        // Mock DocumentData with valid byte array
        byte[] mockData = "Mock PDF Content".getBytes();
        DocumentData mockDocumentData = new DocumentData();
        mockDocumentData.setData(mockData);
        mockDocumentData.setMimetype("application/pdf");

        // Mock JAXBElement
        JAXBElement<DocumentData> mockJAXBElement = mock(JAXBElement.class);
        when(mockJAXBElement.getValue()).thenReturn(mockDocumentData);

        // Explicitly mock the correct marshalSendAndReceive method
        when(webServiceTemplate.marshalSendAndReceive(eq("http://mock.mailservice.url"), any()))
                .thenReturn(mockJAXBElement);

        // Mock ServletOutputStream
        ServletOutputStream mockStream = mock(ServletOutputStream.class);
        when(response.getOutputStream()).thenReturn(mockStream);

        // Call the method
        mailPreferencesDAO.getDocument("12345", "doc123", "update001");

        // Verify mailinbyte usage and response setup
        verify(response).reset();
        verify(response).setHeader("Disposition", "attachment; filename=myDoc.pdf");
        verify(response).setContentType("application/pdf");
        verify(response).setContentLength(mockData.length);
        verify(mockStream).write(mockData);
    }
}
