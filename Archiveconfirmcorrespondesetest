import com.voya.pptcrsp.exception.ExceptionTypeEnum;
import com.voya.pptcrsp.exception.RestClientApiException;
import com.voya.pptcrsp.tf.domain.PenPayData;
import com.voya.pptcrsp.tf.domain.PenPayServiceRequest;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.web.client.RestClient;
import org.springframework.web.client.RestClient.RequestBodySpec;
import org.springframework.web.client.RestClient.RequestHeadersSpec;
import org.springframework.web.client.RestClient.ResponseSpec;

import java.io.ByteArrayInputStream;
import java.io.InputStream;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class PenPayServiceTest {

    @Mock
    private RestClient restClient;

    @Mock
    private RestClient.RequestBodyUriSpec uriSpec;

    @Mock
    private RestClient.RequestBodySpec bodySpec;

    @Mock
    private RestClient.RequestHeadersSpec<?> headersSpec;

    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private PenPayService penPayService;

    private final String serviceUrl = "http://fake-url.com";

    @BeforeEach
    void setUp() {
        penPayService = new PenPayService(restClient, serviceUrl);
    }

    @Test
    void getPaymentHistory_success() {
        PenPayData mockResponse = new PenPayData();

        when(restClient.post()).thenReturn(uriSpec);
        when(uriSpec.uri(serviceUrl)).thenReturn(bodySpec);
        when(bodySpec.body(any(PenPayServiceRequest.class))).thenReturn(headersSpec);
        when(headersSpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.onStatus(any(), any())).thenReturn(responseSpec);
        when(responseSpec.body(PenPayData.class)).thenReturn(mockResponse);

        PenPayData result = penPayService.getPaymentHistory("client1", "participant1");

        assertNotNull(result);
        verify(restClient).post();
    }

    @Test
    void getPaymentHistory_restClientApiException() throws Exception {
        InputStream errorStream = new ByteArrayInputStream("error body".getBytes());

        when(restClient.post()).thenReturn(uriSpec);
        when(uriSpec.uri(serviceUrl)).thenReturn(bodySpec);
        when(bodySpec.body(any(PenPayServiceRequest.class))).thenReturn(headersSpec);
        when(headersSpec.retrieve()).thenReturn(responseSpec);
        when(responseSpec.onStatus(any(), any())).thenAnswer(invocation -> {
            var handler = invocation.getArgument(1);
            var dummyResponse = mock(org.springframework.web.client.RestClient.ResponseSpec.class);
            var responseMock = mock(org.springframework.web.client.ClientResponse.class);
            when(responseMock.getStatusCode()).thenReturn(HttpStatus.BAD_REQUEST);
            when(responseMock.getBody()).thenReturn(errorStream);
            handler.handle(null, responseMock);
            return responseSpec;
        });

        RestClientApiException exception = assertThrows(RestClientApiException.class, () ->
                penPayService.getPaymentHistory("client1", "participant1"));

        assertEquals(ExceptionTypeEnum.REST_API_ERROR, exception.getExceptionType());
        assertEquals(HttpStatus.BAD_REQUEST, exception.getStatusCode());
    }
}
