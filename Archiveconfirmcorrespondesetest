import com.voya.pptcrsp.exception.ExceptionTypeEnum;
import com.voya.pptcrsp.exception.RestClientApiException;
import com.voya.pptcrsp.tf.domain.PenPayData;
import com.voya.pptcrsp.tf.domain.PenPayServiceRequest;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.web.client.RestClient;
import org.springframework.web.client.RestClient.RequestBodySpec;
import org.springframework.web.client.RestClient.ResponseSpec;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class PenPayServiceTest {

    @Mock
    private RestClient restClient;

    @Mock
    private RestClient.RequestBodyUriSpec uriSpec;

    @Mock
    private RestClient.RequestBodySpec bodySpec;

    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private PenPayService penPayService = new PenPayService(restClient, "http://fake-url");

    @Test
    void testGetPaymentHistory_success() {
        PenPayData mockData = new PenPayData();

        when(restClient.post()).thenReturn(uriSpec);
        when(uriSpec.uri(anyString())).thenReturn(bodySpec);
        when(bodySpec.body(any())).thenReturn(responseSpec);
        when(responseSpec.onStatus(any(), any())).thenReturn(responseSpec);
        when(responseSpec.body(PenPayData.class)).thenReturn(mockData);

        PenPayData result = penPayService.getPaymentHistory("client1", "participant1");

        assertNotNull(result);
        verify(restClient).post();
    }

    @Test
    void testGetPaymentHistory_throwsRestClientApiException() throws IOException {
        when(restClient.post()).thenReturn(uriSpec);
        when(uriSpec.uri(anyString())).thenReturn(bodySpec);
        when(bodySpec.body(any())).thenReturn(responseSpec);

        // Simulate error status
        HttpStatusCode statusCode = HttpStatus.INTERNAL_SERVER_ERROR;
        InputStream errorStream = new ByteArrayInputStream("Error Message".getBytes());

        when(responseSpec.onStatus(any(), any())).thenAnswer(invocation -> {
            var statusPredicate = invocation.getArgument(0);
            var errorFunction = invocation.getArgument(1);

            // simulate error trigger
            if (statusPredicate.test(statusCode)) {
                var mockResponse = mock(RestClient.ResponseSpec.ClientResponse.class);
                when(mockResponse.getStatusCode()).thenReturn(statusCode);
                when(mockResponse.getBody()).thenReturn(errorStream);
                try {
                    errorFunction.accept(null, mockResponse);
                } catch (RestClientApiException ex) {
                    throw ex;
                }
            }
            return responseSpec;
        });

        RestClientApiException exception = assertThrows(RestClientApiException.class,
                () -> penPayService.getPaymentHistory("client1", "participant1"));

        assertEquals(ExceptionTypeEnum.REST_API_ERROR, exception.getExceptionTypeEnum());
        assertEquals(statusCode, exception.getStatusCode());
    }
}
