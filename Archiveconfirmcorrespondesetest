@ExtendWith(MockitoExtension.class)
class ArchiveConfirmCorrespondenceServiceTest {

    @Mock
    private ArchiveDocsRestService archiveDocsRestService;

    @Mock
    private RequestService requestService;

    @Mock
    private ClientParticipantInfoCache clientParticipantInfoCache;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private Executor correspondenceExecutor;

    @InjectMocks
    private ArchiveConfirmCorrespondenceService archiveConfirmCorrespondenceService;

    @Test
    void testGetCorrespondenceDocs_validRequest() throws Exception {
        // Mock input
        Map<String, String> reqHeadersMap = Map.of("HeaderKey", "HeaderValue");
        PartyInfo partyInfo = PartyInfo.builder().partyId("123").ssn("456").clientId("789").build();
        Map<String, String> preAuthHeadersMap = Map.of("UC_VENDOR_ID", "SPSRWB", "UC_PLAN_ID_LIST", "plan1,plan2");
        Party party = Party.builder().partyId("123").pptId("456").build();
        List<Account> accountsList = List.of(
            Account.builder().planType("Savings").planId("plan1").build(),
            Account.builder().planType("Other").planId("plan2").build()
        );
        List<Plan> filteredPlans = List.of(new Plan("plan1"), new Plan("plan2"));
        List<ArchiveDocsInfo> archiveDocs = List.of(new ArchiveDocsInfo("doc1"), new ArchiveDocsInfo("doc2"));

        // Mock behavior
        when(requestService.getPreAuthHeadersMap(reqHeadersMap)).thenReturn(preAuthHeadersMap);
        when(requestService.getAccountsList(eq(party), eq(preAuthHeadersMap))).thenReturn(accountsList);
        when(archiveDocsRestService.getEaseCorrespondenceDocList(any(), any(), any()))
            .thenReturn(archiveDocs);

        // Execute
        CorrespondenceResponse response = archiveConfirmCorrespondenceService.getCorrespondenceDocs(reqHeadersMap, partyInfo);

        // Verify
        assertNotNull(response);
        assertEquals(archiveDocs.size(), response.getArchiveDocsInfos().size());
        verify(requestService).getPreAuthHeadersMap(reqHeadersMap);
        verify(requestService).getAccountsList(party, preAuthHeadersMap);
    }

    @Test
    void testSetPlanLvlBrandFlg_customBrandingEnabled() {
        // Mock input
        PartyInfo partyInfo = PartyInfo.builder().clientId("client1").ssn("ssn1").build();
        List<String> planList = List.of("plan1");
        PlanGeneralInfo planGeneralInfo = PlanGeneralInfo.builder().usePlanLevelCustomBranding("Y").build();

        // Mock behavior
        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType("client1", "ssn1", ControlType.WEB))
            .thenReturn(planList);
        when(setItPullClientCache.getSetItPlanGeneralInfo(any()))
            .thenReturn(planGeneralInfo);

        // Execute
        boolean result = archiveConfirmCorrespondenceService.setPlanLvlBrandFlg(partyInfo);

        // Verify
        assertTrue(result);
        verify(clientParticipantInfoCache).getAllPlansByClientParticipantControlType("client1", "ssn1", ControlType.WEB);
        verify(setItPullClientCache).getSetItPlanGeneralInfo(any());
    }

    @Test
    void testSetPlanLvlBrandFlg_noCustomBranding() {
        // Mock input
        PartyInfo partyInfo = PartyInfo.builder().clientId("client1").ssn("ssn1").build();
        List<String> planList = List.of();
        
        // Mock behavior
        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType("client1", "ssn1", ControlType.WEB))
            .thenReturn(planList);

        // Execute
        boolean result = archiveConfirmCorrespondenceService.setPlanLvlBrandFlg(partyInfo);

        // Verify
        assertFalse(result);
        verify(clientParticipantInfoCache).getAllPlansByClientParticipantControlType("client1", "ssn1", ControlType.WEB);
        verifyNoInteractions(setItPullClientCache);
    }
}
