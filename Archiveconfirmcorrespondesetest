package com.voya.ptpcrsp.correspondence.service;

import com.voya.ptpcrsp.correspondence.cache.*;
import com.voya.ptpcrsp.correspondence.model.CorrespondenceResponse;
import com.voya.ptpcrsp.correspondence.model.PartyInfo;
import com.voya.setitpullclient.model.Client;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

@Slf4j
class CombineConfirmCorrespondenceServiceTest {

    @InjectMocks
    private CombineConfirmCorrespondenceService service;

    @Mock
    private MailItConfirmCache mailItConfirmCache;

    @Mock
    private MailitArchiveCache mailitArchiveCache;

    @Mock
    private UserInfoServiceImpl userInfoService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private DocArchiveCache docArchiveCache;

    @Mock
    private RsDataServiceCache rsDataServiceCache;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        service.correspondenceExecutor = Runnable::run; // for async operations
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSourceECOR() {
        Map<String, String> headers = new HashMap<>();
        PartyInfo partyInfo = new PartyInfo();
        Client client = new Client();
        client.setConfirmSource("ECOR");
        
        CorrespondenceResponse response = CorrespondenceResponse.builder().build();
        
        when(userInfoService.getParty(anyMap())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(mailItConfirmCache.getCorrespondenceDocs(anyMap(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any())).thenReturn(Collections.singletonMap("MSG_STATEMENT_BULLET_POINTS", "Bullet Points"));

        CorrespondenceResponse result = service.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals("Bullet Points", result.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSourceDOCARCHIVE() {
        Map<String, String> headers = new HashMap<>();
        PartyInfo partyInfo = new PartyInfo();
        Client client = new Client();
        client.setConfirmSource("DOCARCHIVE");
        
        CorrespondenceResponse response = CorrespondenceResponse.builder().build();
        
        when(userInfoService.getParty(anyMap())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(docArchiveCache.getCorrespondenceArchDocsList(anyMap(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any())).thenReturn(Collections.singletonMap("MSG_STATEMENT_BULLET_POINTS", "Bullet Points"));

        CorrespondenceResponse result = service.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals("Bullet Points", result.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_withConfirmSourceDOCARCHIVEECOR() {
        Map<String, String> headers = new HashMap<>();
        PartyInfo partyInfo = new PartyInfo();
        Client client = new Client();
        client.setConfirmSource("DOCARCHIVEECOR");
        
        CorrespondenceResponse response = CorrespondenceResponse.builder().build();
        
        when(userInfoService.getParty(anyMap())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(client);
        when(mailitArchiveCache.getCorrespondenceDocs(anyMap(), any())).thenReturn(response);
        when(rsDataServiceCache.getSiteManagerValues(any(), any(), any())).thenReturn(Collections.singletonMap("MSG_STATEMENT_BULLET_POINTS", "Bullet Points"));

        CorrespondenceResponse result = service.getCorrespondenceDocs(headers);

        assertNotNull(result);
        assertEquals("Bullet Points", result.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_whenClientIsNull() {
        Map<String, String> headers = new HashMap<>();
        PartyInfo partyInfo = new PartyInfo();
        
        when(userInfoService.getParty(anyMap())).thenReturn(partyInfo);
        when(setItPullClientCache.getClient(any())).thenReturn(null);

        CorrespondenceResponse result = service.getCorrespondenceDocs(headers);

        assertNotNull(result);
    }
}
