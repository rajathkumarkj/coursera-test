import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.ws.client.core.WebServiceTemplate;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import javax.xml.bind.JAXBElement;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.assertNotNull;

class MailPreferencesDAOTest {

    @Mock
    private WebServiceTemplate webServiceTemplate;

    @Mock
    private HttpServletResponse response;

    @InjectMocks
    private MailPreferencesDAO mailPreferencesDAO;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        mailPreferencesDAO = new MailPreferencesDAO(webServiceTemplate, "http://mock.mailservice.url", response);
    }

    @Test
    void testGetDocument_validData() throws Exception {
        // Mock input parameters
        String messageId = "12345";
        String documentId = "doc123";
        String updateId = "update001";

        // Mock DocumentData with valid data
        byte[] mockData = "Mock PDF Content".getBytes();
        DocumentData mockDocumentData = new DocumentData();
        mockDocumentData.setData(mockData);
        mockDocumentData.setMimetype("application/pdf");

        // Mock JAXBElement
        JAXBElement<DocumentData> mockJAXBElement = mock(JAXBElement.class);
        when(mockJAXBElement.getValue()).thenReturn(mockDocumentData);

        // Use `any()` and avoid ambiguity by making sure the return type is properly mocked
        when(webServiceTemplate.marshalSendAndReceive(any(), any()))
                .thenReturn(mockJAXBElement);

        // Mock ServletOutputStream
        ServletOutputStream mockStream = mock(ServletOutputStream.class);
        when(response.getOutputStream()).thenReturn(mockStream);

        // Call the method
        DocumentData result = mailPreferencesDAO.getDocument(messageId, documentId, updateId);

        // Verify and assert
        assertNotNull(result); // Assert result is not null
        verify(response).reset();
        verify(response).setHeader("Disposition", "attachment; filename=myDoc.pdf");
        verify(response).setContentType("application/pdf");
        verify(response).setContentLength(mockData.length);
        verify(mockStream).write(mockData);
        verify(mockStream).flush();
        verify(mockStream).close();
    }
}
