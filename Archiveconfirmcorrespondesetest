import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.ws.client.core.WebServiceTemplate;

import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServletResponse;
import javax.xml.bind.JAXBElement;
import java.io.IOException;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.mockito.Mockito.*;

class MailPreferencesDAOTest {

    @Mock
    private WebServiceTemplate webServiceTemplate;

    @Mock
    private HttpServletResponse response;

    @InjectMocks
    private MailPreferencesDAO mailPreferencesDAO;

    private final String mailServiceUrl = "http://mock.mailservice.url";

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        mailPreferencesDAO = new MailPreferencesDAO(webServiceTemplate, mailServiceUrl, response);
    }

    @Test
    void testGetDocument_success() throws IOException {
        // Mock input parameters
        String messageId = "12345";
        String documentId = "doc123";
        String updateId = "update001";

        // Mock DocumentData response with valid data
        DocumentData mockDocumentData = new DocumentData();
        byte[] mockData = "Mock PDF Content".getBytes();
        mockDocumentData.setData(mockData);
        mockDocumentData.setMimetype("application/pdf");

        JAXBElement<DocumentData> mockJAXBElement = mock(JAXBElement.class);
        when(mockJAXBElement.getValue()).thenReturn(mockDocumentData);

        // Mock the behavior of WebServiceTemplate
        when(webServiceTemplate.marshalSendAndReceive(any(String.class), any())).thenReturn(mockJAXBElement);

        // Mock the ServletOutputStream
        ServletOutputStream mockServletOutputStream = mock(ServletOutputStream.class);
        when(response.getOutputStream()).thenReturn(mockServletOutputStream);

        // Call the method
        DocumentData result = mailPreferencesDAO.getDocument(messageId, documentId, updateId);

        // Verify interactions and assertions
        assertNotNull(result);
        verify(response).reset();
        verify(response).setHeader("Disposition", "attachment; filename=myDoc.pdf");
        verify(response).setContentType("application/pdf");
        verify(response).setContentLength(mockData.length);
        verify(mockServletOutputStream).write(mockData); // Verifies docData.getData() usage
    }
}
