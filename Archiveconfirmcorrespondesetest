import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

import java.util.HashMap;
import java.util.Map;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

class CorrespondenceServiceTest {

    @Mock
    private MailItConfirmCache mailItConfirmCache;

    @Mock
    private MailitArchiveCache mailitArchiveCache;

    @Mock
    private UserInfoServiceImpl userInfoService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private DocArchiveCache docArchiveCache;

    @Mock
    private RsDataServiceCache rsDataServiceCache;

    @InjectMocks
    private CorrespondenceService correspondenceService;

    private Map<String, String> reqHeadersMap;
    private PartyInfo partyInfo;
    private Client client;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);

        reqHeadersMap = new HashMap<>();
        reqHeadersMap.put("Authorization", "Bearer dummyToken");

        partyInfo = new PartyInfo();
        partyInfo.setClientId("clientId");

        client = new Client();
    }

    @Test
    void testGetCorrespondenceDocs_whenConfirmSourceIsECOR() {
        client.setConfirmSource(ConfirmSourceType.ECOR.name());

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);

        CorrespondenceResponse expectedResponse = CorrespondenceResponse.builder().build();
        when(mailItConfirmCache.getCorrespondenceDocs(reqHeadersMap, partyInfo)).thenReturn(expectedResponse);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Sample Bullet Points"));

        CorrespondenceResponse response = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(response);
        assertEquals(ConfirmSourceType.ECOR, response.getConfirmSourceType());
        assertEquals("Sample Bullet Points", response.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_whenConfirmSourceIsDOCARCHIVE() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVE.name());

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);

        CorrespondenceResponse expectedResponse = CorrespondenceResponse.builder().build();
        when(docArchiveCache.getCorrespondenceArchDocsList(reqHeadersMap, partyInfo)).thenReturn(expectedResponse);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Another Bullet Points"));

        CorrespondenceResponse response = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(response);
        assertEquals(ConfirmSourceType.DOCARCHIVE, response.getConfirmSourceType());
        assertEquals("Another Bullet Points", response.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_whenConfirmSourceIsDOCARCHIVEECOR() {
        client.setConfirmSource(ConfirmSourceType.DOCARCHIVEECOR.name());

        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(client);

        CorrespondenceResponse expectedResponse = CorrespondenceResponse.builder().build();
        when(mailitArchiveCache.getCorrespondenceDocs(reqHeadersMap, partyInfo)).thenReturn(expectedResponse);
        when(rsDataServiceCache.getSiteManagerValues(eq("clientId"), isNull(), eq(CrspConstants.MAILPREFERENCES)))
                .thenReturn(Map.of(CrspConstants.MSG_STATEMENT_BULLET_POINTS, "Yet Another Bullet Points"));

        CorrespondenceResponse response = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(response);
        assertEquals(ConfirmSourceType.DOCARCHIVEECOR, response.getConfirmSourceType());
        assertEquals("Yet Another Bullet Points", response.getStatementBulletPoints());
    }

    @Test
    void testGetCorrespondenceDocs_whenClientIsNull() {
        when(userInfoService.getParty(reqHeadersMap)).thenReturn(partyInfo);
        when(setItPullClientCache.getClient("clientId")).thenReturn(null);

        CorrespondenceResponse response = correspondenceService.getCorrespondenceDocs(reqHeadersMap);

        assertNotNull(response); // Should return empty CorrespondenceResponse
    }
}
