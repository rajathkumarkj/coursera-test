import com.voya.crsp.client.*;
import com.voya.crsp.model.*;
import com.voya.crsp.service.*;
import com.voya.crsp.util.*;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.beanutils.BeanUtilsBean;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.BooleanUtils;
import org.apache.commons.lang3.StringUtils;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.*;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.Executor;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
@Slf4j
class CombineConfirmCorrespondenceServiceTest {

    @InjectMocks
    private CombineConfirmCorrespondenceService service;

    @Mock
    private ArchiveDocsRestService archiveDocsRestService;

    @Mock
    private MailItPreferenceService mailItPreferenceService;

    @Mock
    private SetItPullClientCache setItPullClientCache;

    @Mock
    private RequestService requestService;

    @Mock
    private ClientParticipantInfoCache clientParticipantInfoCache;

    @Mock
    private Executor correspondenceExecutor;

    private PartyInfo partyInfo;

    @BeforeEach
    void setUp() {
        partyInfo = PartyInfo.builder()
                .ssn("123456789")
                .clientId("client1")
                .build();
    }

    @Test
    void testGetCorrespondenceDocs_withValidData_returnsResponse() {
        Map<String, String> reqHeadersMap = new HashMap<>();
        Map<String, String> preAuthHeaders = Map.of("someKey", "someValue");

        Account account = new Account();
        account.setPlanType("SAVINGS");
        account.setVoyaAccessPlan(false);
        account.setPlanId("plan1");
        account.setPlanName("Plan Name");

        PlanGeneralInfo generalInfo = new PlanGeneralInfo();
        generalInfo.setUsePlanLevelCustomBranding("Y");

        ArchiveDocsInfo archiveDocsInfo = new ArchiveDocsInfo();
        archiveDocsInfo.setPlanNo("plan1");
        archiveDocsInfo.setPlanName("Plan Name");
        archiveDocsInfo.setSysDocName("DOC001");
        archiveDocsInfo.setUserDocName("User Document");

        DocumentInfo docInfo = new DocumentInfo();
        docInfo.setPlanId("plan1");
        docInfo.setSysDocName("DOC002");
        docInfo.setUserDocName("Mail Doc");
        docInfo.setMessageId("msg123");
        docInfo.setDocumentId("doc123");

        MailInfo mailInfo = new MailInfo();
        mailInfo.setBeginDate(XmlDateUtil.toXMLGregorianCalendar(new Date()));
        mailInfo.setDocumentInfo(List.of(docInfo));

        MailFolder mailFolder = new MailFolder();
        mailFolder.setMailInfo(List.of(mailInfo));

        when(requestService.getPreAuthHeadersMap(reqHeadersMap)).thenReturn(preAuthHeaders);
        when(requestService.getAccountsList(partyInfo, preAuthHeaders)).thenReturn(List.of(account));
        when(setItPullClientCache.getClient("client1")).thenReturn(Client.builder().clientId("client1").confirmSource("OTHER").build());
        when(archiveDocsRestService.getEaseCorrespondenceDocList(eq("123456789"), any(), eq(true)))
                .thenReturn(List.of(archiveDocsInfo));
        when(mailItPreferenceService.getCombinedMailFolder(any(), any(), any(), any(), any(), any()))
                .thenReturn(mailFolder);
        when(clientParticipantInfoCache.getAllPlansByClientParticipantControlType(any(), any(), any()))
                .thenReturn(List.of("plan1"));
        when(setItPullClientCache.getSetItPlanGeneralInfo(any())).thenReturn(generalInfo);

        // Mock async executor
        doAnswer(invocation -> {
            Runnable runnable = invocation.getArgument(0);
            runnable.run();
            return null;
        }).when(correspondenceExecutor).execute(any());

        CorrespondenceResponse response = service.getCorrespondenceDocs(reqHeadersMap, partyInfo);

        assertNotNull(response);
        assertTrue(response.isUsePlanLvlBrand());
        assertNotNull(response.getComboCorresInfos());
        assertFalse(response.getComboCorresInfos().isEmpty());
    }
}
