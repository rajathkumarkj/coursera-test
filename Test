@Test
void testFilterPlans_WithAllConditionsMet() throws Exception {
    // Mock the preAuthHeadersMap and clientId
    Map<String, String> preAuthHeadersMap = Map.of(
        "UC_VENDOR_ID", "SPSRWB", // Match the vendor ID
        "UC_PLAN_ID_LIST", "plan1,plan2" // List of plan IDs that should pass filtering
    );
    String clientId = "client123";

    // Mock DocumentInfo and MailInfo
    DocumentInfo doc1 = mock(DocumentInfo.class);
    DocumentInfo doc2 = mock(DocumentInfo.class);
    DocumentInfo doc3 = mock(DocumentInfo.class);

    when(doc1.getPlanId()).thenReturn("plan1"); // Should match plan1 from preAuthHeadersMap
    when(doc2.getPlanId()).thenReturn("plan3"); // Should not match any in preAuthHeadersMap
    when(doc3.getPlanId()).thenReturn("plan2"); // Should match plan2 from preAuthHeadersMap

    MailInfo mailInfo = mock(MailInfo.class);
    when(mailInfo.getDocumentInfo()).thenReturn(List.of(doc1, doc2, doc3));

    List<MailInfo> mailInfoList = List.of(mailInfo);

    // Access private method filterPlans using reflection
    Method filterPlansMethod = MailItConfirmCorrespondenceService.class.getDeclaredMethod(
        "filterPlans", List.class, Map.class, String.class
    );
    filterPlansMethod.setAccessible(true);

    // Call the private method using reflection
    List<MailInfo> result = (List<MailInfo>) filterPlansMethod.invoke(service, mailInfoList, preAuthHeadersMap, clientId);

    // Debugging: Print the result
    System.out.println("Filtered MailInfo List Size: " + result.size());
    result.forEach(mailInfoResult -> {
        System.out.println("MailInfo Document Size: " + mailInfoResult.getDocumentInfo().size());
        mailInfoResult.getDocumentInfo().forEach(doc -> {
            System.out.println("Document PlanId: " + doc.getPlanId());
        });
    });

    // Verify the result
    assertNotNull(result);
    assertEquals(1, result.size(), "There should be only one MailInfo object remaining."); // Only one MailInfo object should remain
    List<DocumentInfo> filteredDocuments = result.get(0).getDocumentInfo();
    assertEquals(2, filteredDocuments.size(), "There should be exactly two documents with valid plan IDs.");

    // Check that only the documents with matching plan IDs remain
    assertTrue(filteredDocuments.stream().anyMatch(doc -> "plan1".equals(doc.getPlanId())), "plan1 should be included.");
    assertTrue(filteredDocuments.stream().anyMatch(doc -> "plan2".equals(doc.getPlanId())), "plan2 should be included.");
    assertFalse(filteredDocuments.stream().anyMatch(doc -> "plan3".equals(doc.getPlanId())), "plan3 should not be included.");
}
